const TMDB_IMG_BASE="https://i0.wp.com/image.tmdb.org/t/p/w500";(()=>{let e,t=!navigator.onLine;const n=e=>e?e.toString().toLowerCase().trim().replace(/\s+/g,"-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-"):"",a=e=>{const t=[e.original_title,e.original_name,e.title,e.name];for(const e of t)if(e){if(n(e))return e}return`show-${e.id}`};async function o(){const e=document.getElementById("recommendations-list"),t=document.getElementById("recommendations-container");if(!e||!t)return;const o=new URL(window.location.href),s=o.searchParams.get("lang")||"en",i=o.pathname.match(/\/(movie|tv)\/(\d+)/);if(!i)return;const[r,l,d]=i;try{const o=await fetch(`/api/recommendations/${l}/${d}?lang=${s}`);if(!o.ok)throw new Error("Failed to fetch recommendations");const i=await o.json();if(i&&i.length>0){const t=i.map((e=>function(e,t){const o=e.title||e.name,s=n(a(e)),i=e.release_date||e.first_air_date?new Date(e.release_date||e.first_air_date).getFullYear():"N/A",r=e.media_type||"movie";let l="tv"===r?`/tv/${e.id}/${s}`:`/${r}/${e.id}/${s}-${i}`;return t&&"en"!==t&&(l+=`?lang=${t}`),`\n      <div class="d-flex mb-3">\n        <div class="flex-shrink-0">\n          <a href="${l}">\n            <img src="preloader.svg" data-src="${e.poster_path?`${TMDB_IMG_BASE}${e.poster_path}`:"no-image.svg"}" width="76" height="100%" class="lazyload faded rounded-3" alt="Poster for ${o}" title="${o}">\n          </a>\n        </div>\n        <div class="ms-3">\n          <div class="fs-6 mb-0">\n            <a href="${l}" title="${o}" class="link-body-emphasis text-decoration-none">${o}</a>\n          </div>\n          <span class="text-muted">${i}</span>\n          <div class="text-warning small"><i class="fas fa-star me-1"></i>${e.vote_average.toFixed(1)}</div>\n        </div>\n      </div>`}(e,s))).join("");e.innerHTML=t,e.classList.remove("text-center","py-5")}else t.style.display="none"}catch(e){console.error("Error loading recommendations:",e),t.style.display="none"}}function s(e){[...e.querySelectorAll('[data-bs-toggle="tooltip"]')].map((e=>new bootstrap.Tooltip(e)));[...e.querySelectorAll('[data-bs-toggle="popover"]')].map((e=>new bootstrap.Popover(e)))}function i(){const e=()=>localStorage.getItem("theme"),t=e=>{const t="auto"===e?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":e;document.documentElement.setAttribute("data-bs-theme",t);const n="dark"===t?"#212529":"#fbfbfb";document.querySelector('meta[name="theme-color"]')?.setAttribute("content",n);const a=document.getElementById("theme-icon-light"),o=document.getElementById("theme-icon-dark");a&&o&&(a.style.display="light"===t?"inline-block":"none",o.style.display="dark"===t?"inline-block":"none")};t(e()||"auto"),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",(()=>{"auto"!==e()&&e()||t("auto")})),document.getElementById("theme-toggler")?.addEventListener("click",(e=>{e.preventDefault();const n="dark"===document.documentElement.getAttribute("data-bs-theme")?"light":"dark";localStorage.setItem("theme",n),t(n)}))}function r(){const e=document.querySelector(".movie-grid");if(!e)return;const t=e.dataset.path,o=e.dataset.mediatype;if(!t&&!o)return;let s=parseInt(e.dataset.page)||1;const i=parseInt(e.dataset.totalPages)||1;if(s>=i)return;let r=!1;const l=document.createElement("div");l.id="loader-container",l.className="col-12 text-center py-5",e.parentNode.appendChild(l);const d=async()=>{if(!(r||s>=i)){r=!0,l.innerHTML='<div class="spinner-grow text-secondary" role="status"><span class="visually-hidden">Loading...</span></div>';try{const d=new URL(window.location.origin),c=new URLSearchParams(window.location.search),m=c.get("lang")||"en";if(t&&t.startsWith("/search"))d.pathname="/api/search",c.has("q")&&d.searchParams.set("q",c.get("q"));else{if(!o)return r=!1,void(l.innerHTML="");{d.pathname="/api/list";const t=e.dataset.genreSlug;d.searchParams.set("mediaType",o),t&&d.searchParams.set("genre",t)}}d.searchParams.set("page",s+1),"en"!==m&&d.searchParams.set("lang",m);const u=await fetch(d.toString()),g=await u.json();if(g.results&&g.results.length>0){const t=g.results.map((e=>function(e,t){const o=e.title||e.name,s=e.release_date||e.first_air_date?new Date(e.release_date||e.first_air_date).getFullYear():"N/A",i=n(a(e));let r="tv"===e.media_type?`/tv/${e.id}/${i}`:`/movie/${e.id}/${i}-${s}`;return t&&"en"!==t&&(r+=`?lang=${t}`),`\n      <div class="col-6 col-md-4 col-lg-2">\n        <div class="card bg-transparent border-0 h-100 movie-card shadow-none">\n          <a href="${r}" title="${o} (${s})" class="position-relative">\n            <img src="preloader.svg" data-src="${e.poster_path?`${TMDB_IMG_BASE}${e.poster_path}`:"no-image.svg"}" class="lazyload card-img-top rounded-3" alt="Poster for ${o}">\n            <div class="card-img-overlay d-flex flex-column justify-content-end p-2">\n              <div class="play-icon"><i class="fas fa-play-circle"></i></div>\n            </div>\n            <span class="badge bg-dark bg-opacity-75 position-absolute top-0 end-0 m-2">\n              <i class="fas fa-star text-warning me-1"></i>${e.vote_average.toFixed(1)}\n            </span>\n          </a>\n          <div class="card-body p-2 text-center">\n            <div class="card-title text-truncate mb-0">\n              <a href="${r}" title="${o} (${s})" class="link-body-emphasis text-decoration-none">${o}</a>\n            </div>\n            <small class="text-muted">${s}</small>\n          </div>\n        </div>\n      </div>`}(e,m))).join("");e.insertAdjacentHTML("beforeend",t),s++}else s=i}catch(e){console.error("Failed to load more content:",e),s=i}finally{r=!1,l.innerHTML=s>=i?"<p class='text-muted'>No more results.</p>":""}}};new IntersectionObserver((e=>{e[0].isIntersecting&&d()}),{rootMargin:"200px"}).observe(l)}async function l(){const e=document.getElementById("user-signup-notification");if(!e)return;const t=bootstrap.Toast.getOrCreateInstance(e,{delay:6e3}),n=document.getElementById("user-signup-message");try{const e=new URL(window.location.href).searchParams.get("lang")||"en",a=await fetch(`/api/user?lang=${e}`),o=await a.json();if(!o.notifications||0===o.notifications.length)return;const s=()=>{const e=o.notifications[Math.floor(Math.random()*o.notifications.length)];e&&(n.innerHTML=e.messageContent,t.show(),setTimeout(s,12e3*Math.random()+12e3))};setTimeout(s,6e3)}catch(e){console.error("Failed to fetch data for user signups:",e)}}function d(e,t=!1){const n=document.getElementById("status-toast");if(!n)return;const a=bootstrap.Toast.getOrCreateInstance(n,{autohide:!t,delay:5e3});n.querySelector(".toast-body").textContent=e,n.classList.remove("text-bg-success","text-bg-danger","still-offline");const o=n.querySelector(".btn-close");t?(n.classList.add("still-offline"),o&&o.classList.add("btn-close-white")):navigator.onLine?(n.classList.add("text-bg-success","text-white"),o&&o.classList.add("btn-close-white")):(n.classList.add("text-bg-danger","text-white"),o&&o.classList.add("btn-close-white")),a.show()}function c(){const e=document.getElementById("install-banner"),t=document.getElementById("install-button"),n=document.getElementById("close-install-button");if(!e||!t||!n||"true"===localStorage.getItem("pwaInstallDismissed"))return;const a=(t=!1)=>{t&&localStorage.setItem("pwaInstallDismissed","true"),e.classList.remove("show"),e.addEventListener("transitionend",(()=>e.classList.add("d-none")),{once:!0})};window.addEventListener("beforeinstallprompt",(n=>{n.preventDefault();const o=n;e.classList.remove("d-none"),setTimeout((()=>e.classList.add("show")),50),t.addEventListener("click",(()=>{a(!0),o.prompt(),o.userChoice.then((e=>{"accepted"===e.outcome&&setTimeout((()=>{d("App installed! Check your home screen to open it.")}),1e3)}))}),{once:!0})})),n.addEventListener("click",(()=>{a(!0)})),"serviceWorker"in navigator&&window.addEventListener("load",(()=>{navigator.serviceWorker.register("/sw.js"),navigator.onLine||d("You're still offline.",!0)}))}function m(){if(e)return;const t=document.getElementById("player");if(t){const n=t.dataset.videoid;n&&(e=new YT.Player("player",{height:"100%",width:"100%",videoId:n,playerVars:{autoplay:0,controls:1,modestbranding:1,rel:0},events:{onStateChange:g,onReady:u}}))}}function u(e){}function g(e){e.data===YT.PlayerState.ENDED&&p()}window.onYouTubeIframeAPIReady=function(){m()};const p=()=>{const t=document.getElementById("video-container");if(!t)return;const n=t.dataset.posterurl,a=t.dataset.backdropurl,o=t.dataset.title,s=a&&!a.includes("no-image.svg")?a:n;e&&"function"==typeof e.destroy&&(e.destroy(),e=null),t.innerHTML=`\n      <img src="${s}" class="lazyload img-fluid w-100" style="object-fit: cover; height: 100%;" alt="Backdrop for ${o}">\n      <div class="video-overlay">\n          <a href="javascript:void(0)" class="replay-icon" aria-label="Signup">\n              <i class="fa fa-play"></i>\n          </a>\n      </div>`,t.querySelector(".replay-icon").addEventListener("click",showSignupModal),showSignupModal()};window.showSignupModal=()=>{const e=document.getElementById("signupModal");if(!e)return;const t=bootstrap.Modal.getInstance(e);if(t&&t._isShown)return;const n=e.querySelector(".modal-content");n&&n.classList.add("has-bg");(t||new bootstrap.Modal(e)).show(),e.addEventListener("hidden.bs.modal",(()=>{n&&n.classList.remove("has-bg")}),{once:!0})},window.startPlayback=t=>{const n=document.getElementById("video-container");n&&(e&&"function"==typeof e.destroy&&(e.destroy(),e=null),n.innerHTML=`<iframe id="myVideo" class="loading" src="${t}" allowfullscreen></iframe>`,setTimeout((()=>{document.fullscreenElement||showSignupModal()}),9e4))},document.addEventListener("DOMContentLoaded",(()=>{i(),s(document.body),async function(){const e=document.getElementById("genre-dropdown");if(e)try{const t=new URL(window.location.href).searchParams.get("lang")||"en",n=await fetch(`/api/genres?lang=${t}`),a=await n.json();if(a&&a.length>0){const n="en"!==t?`?lang=${t}`:"";e.innerHTML=a.map((e=>`<li><a class="dropdown-item" href="/genre/${e.slug}${n}">${e.name}</a></li>`)).join("")}else e.innerHTML='<li><a class="dropdown-item" href="#">No genres found</a></li>'}catch(t){console.error("Failed to load genres:",t),e.innerHTML='<li><a class="dropdown-item" href="#">Error loading genres</a></li>'}}(),document.addEventListener("show.bs.collapse",(e=>{const t=document.querySelector(`a[href="#${e.target.id}"]`);t&&(t.querySelector(".read-more")?.setAttribute("style","display: none;"),t.querySelector(".read-less")?.setAttribute("style","display: inline;"))})),document.addEventListener("hide.bs.collapse",(e=>{const t=document.querySelector(`a[href="#${e.target.id}"]`);t&&(t.querySelector(".read-more")?.setAttribute("style","display: inline;"),t.querySelector(".read-less")?.setAttribute("style","display: none;"))})),r(),c(),function(){const e=()=>{const e=navigator.onLine;e?t&&d("You are back online!"):d("You are currently offline."),t=!e};window.addEventListener("online",e),window.addEventListener("offline",e)}(),o(),"undefined"!=typeof YT&&YT.Player&&m();new MutationObserver((e=>{for(const t of e)"childList"===t.type&&t.addedNodes.forEach((e=>{1===e.nodeType&&s(e)}))})).observe(document.body,{childList:!0,subtree:!0}),"true"===document.body.dataset.signupEnabled&&requestIdleCallback((()=>setTimeout(l,6e3)),{timeout:4e3})}))})();
